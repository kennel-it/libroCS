<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html>
<!-- autoIndex requires="API FetchAPI" group="javascript" coords="60,30" -->
<!-- changelog 2025-09-11 inserito capitolo -->
<!-- changelog 2025-09-20 descrizione generale e funzione per recuperare menù -->
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
    <meta charset="UTF-8"/>
       <title>universalFood</title>
       <link type="text/css" rel="stylesheet" href="style.css"/>
       <script type="text/javascript" src="script/test.js"></script>
       <style>
         code span { 
            display: inline-block;
            background-color: yellow;
            color: black;
            border: 1px solid #ffcc00;
            border-radius: 0.5em; 
            padding-right: 1em;
         }
       </style>
   </head>
<body>
<header>
    <h1>UniversalFood</h1>
    <p>Esempio di uso di web API</p>
</header>
<article>
    <h2>Utilizzare API di un server remoto</h2>
    <!-- WIP -->
    <img src="immagini/wip.png" alt="lavori in corso">

    <p>Come esempio di applicazione lato client creiamo un gestore di un menu
    per un ristorante che serve piatti di diverse parti del mondo.
    Il ristorante ha diversi menù che si caratterizzano per la nazione che
    rappresentano, ogni menù contiene diversi piatti.</p>
    <p>Per consentirci di sviluppare la prima applicazione client
    con maggiore comodità usiamo un server che possiamo tenere sotto
    controllo (cosa che invece non si può di solito fare con un server
    reale). Il server può essere scaricato dal
    <a href="https://github.com/kennel-it/libroCS/releases/tag/universalFood1.0.0">
    repository del libro su GitHub</a> e dopo il suo avvio
    si può accedere ai suoi servizi dall'indirizzo
    <code>http://localhost:8180</code>, da questa pagina si possono fare due cose:</p>
    <ol>
        <li>Esplorare le API, cosa che in qualche modo si può fare
        su qualsiasi servizio.</li>
        <li>Accedere al database, cosa che è impossibile su un server
        di API e che in effetti non è necessaria: non ci importa in genere come
        il server organizza i dati, questa volta possiamo
        soltanto per curiosare un pò.</li>
    </ol>
    <p>I dati presenti nel server si resettano ad ogni suo avvio
    quindi nessun problema se il db lo roviniamo per sbaglio o se
    inseriamo dati inutili: basta riabbiare il server chiudento la finestra
    e rilanciandolo.</p>
    
    <h2>API disponibile</h2>
    <p>La prima cosa da fare è curiosare nelle pagine dell'API,
    a prima vista potrebbe sembrare complessa ma consente di fare molte cose
    come ad esempio provare ad interagire con il server.</p>
    <p>Prima di tutto guardiamo l'elenco degli end point:
    <img src="immagini/API_elenco.png" alt="elenco API disponibili" style="width:100%"></img>
    nell'ordine di ciascun servizio vediamo: il metodo, la url e
    una brevissima descrizione, sulla destra c'è una freccia per aprire
    i dettagli. Come esempio proviamo a vedere l'enpoint
    <em>/universalfood/piatto/{id}</em> facendo click sulla freccia sulla destra.</p>

    <p><img src="immagini/API_dettagli.png" alt="APPI per dettagli su un piatto" style="width:100%"></img>
    da qui facendo click sul pulsante "Try it out" è possibile
    inviare una richiesta al server e vedere cosa ci risponde,
    basta ad esempio scrivere "22" nel campo id e poi click sul palsante
    execute che è apparso nel frattempo.</p>
    
    <p>Questo è il momento giusto per fare molti esperimenti, magari inserire dati
    usando un end point con metodo POST o fare ricerche.</p>

    <h2>Applicazione per consultare il menù</h2>
    <p>La prima applicazione che costruiamo serve a consultare il menù
    del ristorante: una casella di scelta mi permette di scegliere
    quale menù (quindi quale parte del mondo per come è organizzato
    il ristorante) mi interessa e dopo averlo selezionato mi mostra una tabella
    con tutti i piatti disponibili per quel menù.</p>
    
    <p>L'applicazione Javascript è riportata qui sotto, ci soffermiamo
    sulle parti che riguardano l'interazione con l'API pubblica di
    UniversalFood. Tutto in realtà inizia da [7]: quando la
    pagina viene caricata si chiama la funzione <code>caricaMenu()</code>
    che serve appunto a caricare il <code>select</code> che contiene
    l'elenco dei menù. La funzione asincrona [2] invia la richiesta
    al server usando <code>fetch()</code> e una volta recuperato il
    risultato lo decodifica usandoil metodo <code>json()</code>
    della risposta ottenuta. Da questo punto in poi si prosegue
    creando un elemento option per ogni elemento della risposta
    (che sappiamo essere un vettore avengo guardato l'API).</p>
    
    <p>L'appreoccio della funzione descritta sopra è un pochino troppo ottimistico:
    e se qualcosa dovrebbe andar male?
    Per questo la compilazione della tabella dei piatti in un menù
    usa una strategia un pochino diversa: la funzione <code>scelto()</code>
    viene chiamata quando l'utente sceglie un menù
    come specificato in [8] ma questa una un try [2] con il relativo
    catch [6] che gestisce eventuali errori in comunicazione.
    Anche la gestione delle riposta alla richiesta [3] per uno
    specifico piatto verifica se tutto è andato bene con l'if [4].
    Questa funzione a differenza della precedente genera una tabella
    costruendo l'HTML come testo e inserendolo poi in un <code>div</code>
    già presente nella pagina.</p>
    
<pre><code>
&lt;!DOCTYPE html&gt;
&lt;html lang="it"&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;title&gt;Menu interattivo&lt;/title&gt;
  &lt;style&gt;
table { border-collapse: collapse}
td { border: 1px solid gray ; padding: 0.5em }
#errore { color:red }
  &lt;/style&gt;
  &lt;script&gt;
"use strict";

<em>async function caricaMenu(){ <span>// 1</span>
  let risposta = await fetch("http://localhost:8180/universalfood/menu");
  let elencoMenu = await risposta.json();</em>
  console.log(elencoMenu);
  for(let i=0;i&lt;elencoMenu.length; i++){
    let elemento = document.createElement("option");
    elemento.value=elencoMenu[i].id;
    elemento.innerText=elencoMenu[i].nome;
    menu.appendChild(elemento);
  }
}

<em>async function scelto(){
  try{</em> <span>// 2</span>
    let id=menu.value;
    // id=75; da mettere per causare un errore
    <em>let risposta = await fetch("http://localhost:8180/universalfood/menu/"+id); <span>// 3</span>
    if(risposta.ok){</em> <span>// 4</span>
      let menuScelto = await risposta.json();
      nazione.innerText = menuScelto.nome;
      descrizione.innerText = menuScelto.descrizione;
      let tabella="&lt;table&gt;";
      for(let i=0; i&lt;menuScelto.piatti.length; i++){
        let piatto = menuScelto.piatti[i];
        if(piatto.disponibile){
          tabella += `&lt;tr&gt;&lt;td&gt;${piatto.nome}&lt;/td&gt;&lt;td&gt;${piatto.descrizione}&lt;/td&gt;&lt;/tr&gt;`;
        }
      }
      tabella += "&lt;/table&gt;";
      dettagli.innerHTML = tabella;
    <em>}else{ <span>// 5</span>
      errore.innerText='stato:'+risposta.status+" "+risposta.statusText;
    }
  }catch(e){ <span>// 6</span>
    errore.innerText = e.message;
  }</em>
}
  &lt;/script&gt;
&lt;/head&gt;
&lt;body <em>onload="caricaMenu()</em>"&gt; <span>&lt;!-- 7 !&gt;</span>
  &lt;h1&gt;Universal Food&lt;/h1&gt;
  &lt;p&gt;Menù interattivo&lt;/p&gt;
  &lt;p&gt;Scegli un menu: &lt;select id="menu" onchange="scelto()" &gt;&lt;/select&gt;&lt;/p&gt; <span>&lt;!-- 8 !&gt;</span>

  &lt;p&gt;Nazione: &lt;span id="nazione"&gt;&lt;/span&gt;&lt;/p&gt;
  &lt;p&gt;Descrizione: &lt;span id="descrizione"&gt;&lt;/span&gt;&lt;/p&gt;
  &lt;div id="dettagli"&gt;&lt;/div&gt;
  &lt;p id="errore"&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
</article>
</body>
</html>
