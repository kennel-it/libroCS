<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html>
<!-- autoIndex requires="API FetchAPI" group="javascript" -->
<!-- changelog 2025-09-11 inserito capitolo -->
<!-- changelog 2025-09-20 completato il capitolo -->
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
    <meta charset="UTF-8"/>
       <title>universalFood</title>
       <link type="text/css" rel="stylesheet" href="style.css"/>
       <script type="text/javascript" src="script/test.js"></script>
       <style>
         code span {
            display: inline-block;
            background-color: yellow;
            color: black;
            border: 1px solid #ffcc00;
            border-radius: 0.5em;
            padding-right: 1em;
         }
       </style>
   </head>
<body>
<header>
    <h1>UniversalFood</h1>
    <p>Esempio di uso di web API</p>
</header>
<article>
    <h2>Utilizzare API di un server remoto</h2>

    <p>Come esempio di applicazione lato client creiamo un gestore di un menu
    per il ristorante UniversalFood che serve piatti di diverse parti del mondo.
    Il ristorante ha diversi menù che si caratterizzano per la nazione che
    rappresentano, ogni menù contiene diversi piatti.</p>
    <p>Per consentirci di sviluppare la prima applicazione client
    con maggiore comodità usiamo un server che possiamo tenere sotto
    controllo (cosa che invece non si può di solito fare con un server
    reale). Il server può essere scaricato dal
    <a href="https://github.com/kennel-it/libroCS/releases/tag/universalFood1.0.0">
    repository del libro su GitHub</a> e dopo il suo avvio
    si può accedere ai suoi servizi dall'indirizzo
    <code>http://localhost:8180</code>, da questa pagina si possono fare due cose:</p>
    <ol>
        <li>Esplorare le API, cosa che in qualche modo si può fare
        su qualsiasi servizio.</li>
        <li>Accedere al database, cosa che è impossibile su un server
        di API e che in effetti non è necessaria: non ci importa in genere come
        il server organizza i dati, questa volta possiamo
        soltanto per curiosare un po'.</li>
    </ol>
    <p>I dati presenti nel server si resettano ad ogni suo avvio
    quindi nessun problema se il db lo roviniamo per sbaglio o se
    inseriamo dati inutili: basta riavviare il server chiudento la finestra
    e rilanciandolo.</p>

    <h2>API disponibile</h2>
    <p>La prima cosa da fare è curiosare nelle pagine dell'API,
    a prima vista potrebbe sembrare complessa ma consente di fare molte cose
    come ad esempio provare ad interagire con il server.</p>
    <p>Prima di tutto guardiamo l'elenco degli end point:
    <img src="immagini/API_elenco.png" alt="elenco API disponibili" style="width:100%"></img>
    nell'ordine di ciascun servizio vediamo: il metodo, la url e
    una brevissima descrizione, sulla destra c'è una freccia per aprire
    i dettagli. Come esempio proviamo a vedere l'enpoint
    <em>/universalfood/piatto/{id}</em> facendo click sulla freccia sulla destra.</p>

    <p><img src="immagini/API_dettagli.png" alt="APPI per dettagli su un piatto" style="width:100%"></img>
    da qui facendo click sul pulsante "Try it out" è possibile
    inviare una richiesta al server e vedere cosa ci risponde,
    basta ad esempio scrivere "22" nel campo id e poi click sul palsante
    execute che è apparso dopo aver fatto click su "try it out".</p>

    <p>Questo è il momento giusto per fare molti esperimenti, magari inserire dati
    usando un end point con metodo POST o fare ricerche.</p>


    <h2>Applicazione per consultare il menù</h2>
    <p>La prima applicazione che costruiamo serve a consultare il menù
    del ristorante: una casella di scelta mi permette di scegliere
    quale menù (quindi quale parte del mondo per come è organizzato
    il ristorante) mi interessa e dopo averlo selezionato mi mostra una tabella
    con tutti i piatti disponibili per quel menù.</p>

    <p>L'applicazione Javascript è riportata qui sotto, ci soffermiamo
    sulle parti che riguardano l'interazione con l'API pubblica di
    UniversalFood. Tutto in realtà inizia da [7]: quando la
    pagina viene caricata si chiama la funzione <code>caricaMenu()</code>
    che serve appunto a caricare il <code>select</code> che contiene
    l'elenco dei menù. La funzione asincrona [1] invia la richiesta
    al server usando <code>fetch()</code> e una volta recuperato il
    risultato lo decodifica usandoil metodo <code>json()</code>
    della risposta ottenuta. Da questo punto in poi si prosegue
    creando un elemento option per ogni elemento della risposta
    (che sappiamo essere un vettore avengo guardato l'API).</p>

    <p>L'approccio della funzione descritta sopra è un pochino troppo ottimistico:
    e se qualcosa dovesse andar male?
    Per questo la compilazione della tabella dei piatti in un menù
    usa una strategia un pochino diversa: la funzione <code>scelto()</code>
    viene chiamata quando l'utente sceglie un menù
    come specificato in [8] ma questa usa un try [2] con il relativo
    catch [6] che gestisce eventuali errori in comunicazione.
    Anche la gestione delle riposta alla richiesta [3] per uno
    specifico piatto verifica se tutto è andato bene con l'if [4].
    Questa funzione a differenza della precedente genera una tabella
    costruendo l'HTML come testo e inserendolo poi in un <code>div</code>
    già presente nella pagina.</p>

<pre><code>
&lt;!DOCTYPE html&gt;
&lt;html lang="it"&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;title&gt;Menu interattivo&lt;/title&gt;
  &lt;style&gt;
table { border-collapse: collapse}
td { border: 1px solid gray ; padding: 0.5em }
#errore { color:red }
  &lt;/style&gt;
  &lt;script&gt;
"use strict";

<em>async function caricaMenu(){ <span>// 1</span>
  let risposta = await fetch("http://localhost:8180/universalfood/menu");
  let elencoMenu = await risposta.json();</em>
  console.log(elencoMenu);
  for(let i=0;i&lt;elencoMenu.length; i++){
    let elemento = document.createElement("option");
    elemento.value=elencoMenu[i].id;
    elemento.innerText=elencoMenu[i].nome;
    menu.appendChild(elemento);
  }
}

<em>async function scelto(){
  try{</em> <span>// 2</span>
    let id=menu.value;
    // id=75; da mettere per causare un errore
    <em>let risposta = await fetch("http://localhost:8180/universalfood/menu/"+id); <span>// 3</span>
    if(risposta.ok){</em> <span>// 4</span>
      let menuScelto = await risposta.json();
      nazione.innerText = menuScelto.nome;
      descrizione.innerText = menuScelto.descrizione;
      let tabella="&lt;table&gt;";
      for(let i=0; i&lt;menuScelto.piatti.length; i++){
        let piatto = menuScelto.piatti[i];
        if(piatto.disponibile){
          tabella += `&lt;tr&gt;&lt;td&gt;${piatto.nome}&lt;/td&gt;&lt;td&gt;${piatto.descrizione}&lt;/td&gt;&lt;/tr&gt;`;
        }
      }
      tabella += "&lt;/table&gt;";
      dettagli.innerHTML = tabella;
    <em>}else{ <span>// 5</span>
      errore.innerText='stato:'+risposta.status+" "+risposta.statusText;
    }
  }catch(e){ <span>// 6</span>
    errore.innerText = e.message;
  }</em>
}
  &lt;/script&gt;
&lt;/head&gt;
&lt;body <em>onload="caricaMenu()</em>"&gt; <span>&lt;!-- 7 !&gt;</span>
  &lt;h1&gt;Universal Food&lt;/h1&gt;
  &lt;p&gt;Menù interattivo&lt;/p&gt;
  &lt;p&gt;Scegli un menu: &lt;select id="menu" onchange="scelto()" &gt;&lt;/select&gt;&lt;/p&gt; <span>&lt;!-- 8 !&gt;</span>

  &lt;p&gt;Nazione: &lt;span id="nazione"&gt;&lt;/span&gt;&lt;/p&gt;
  &lt;p&gt;Descrizione: &lt;span id="descrizione"&gt;&lt;/span&gt;&lt;/p&gt;
  &lt;div id="dettagli"&gt;&lt;/div&gt;
  &lt;p id="errore"&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>


    <h2>Applicazione per inserire un piatto</h2>
    <p>Questa applicazione inserisce un piatto in un menù specifico,
    per questo è presente la stessa casella di scelta dell'esercizio precedente
    che consentirà all'utente di decidere in quale menù inserire il piatto.</p>

    <p>Il pulsante [7] "invia nuovo piatto" chiama la funzione
    <code>inviaNuovoPiatto()</code> che come prima cosa prepara
    l'oggetto da inviare al server [2], in particolare questo oggetto ha una
    proprietà "menu" che è a sua volta un oggetto di cui specifichiamo
    il solo id (quello del menù scelto dall'utente).
    In [3] creo una stringa con la rappresentazione JSON dell'oggetto appena definito,
    subito sotto [4] preparo un oggetto con tutti i parametri della
    richiesta da inviare al server, compreso il metodo "POST",
    l'indicazione del formato application/json e la stringa JSON creata
    (inserita nella proprietà "body").</p>
    <p>La richiesta viene inviata [5] usando che URL base quella definita
    all'inizio del programma [1], questo può far comodo  caso ad esempio
    cambi l'indirizzo del server e cosa molto più utile ci evita di scrivere
    lo stesso indirizzo tante volte. Una volta inviata la richiesta
    è importante vedere come è andata [6] per sapere se il dato è stato inserito
    o meno.</p>

<pre><code>
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;Menu interattivo&lt;/title&gt;
    &lt;style&gt;
table { border-collapse: collapse}
td { border: 1px solid gray ; padding: 0.5em }
    &lt;/style&gt;
    &lt;script&gt;
"use strict";

const URL_SERVER = "http://localhost:8180/universalfood"; <span>// 1</span>

<div class="vecchio">async function caricaMenu(){
    let risposta = await fetch(URL_SERVER+"/menu");
    let elencoMenu = await risposta.json();
    console.log(elencoMenu);
    for(let i=0;i&lt;elencoMenu.length; i++){
        let elemento = document.createElement("option");
        elemento.value=elencoMenu[i].id;
        elemento.innerText=elencoMenu[i].nome;
        menu.appendChild(elemento);
    }
}</div>

async function inviaNuovoPiatto(){
    let nuovoPiatto = { <span>// 2</span>
        menu: {id: menu.value},
        nome: document.getElementById("nome").value,
        costo: document.getElementById("costo").value,
        descrizione: document.getElementById("descrizione").value,
        disponibile: true
    };
    let piattoJson = JSON.stringify(nuovoPiatto); <span>// 3</span>
    console.log(piattoJson);

    try{
        let parametriRichiesta = { <span>// 4</span>
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: piattoJson
        };
        let risposta = await fetch(URL_SERVER+"/piatto",parametriRichiesta); <span>// 5</span>
        if(risposta.ok){ <span>// 6</span>
            esito.innerText = "piatto inserito";
            esito.style.color = "green";
        } else {
            esito.innerText = 'stato:'+risposta.status+" "+risposta.statusText;
            esito.style.color = "red";
        }
    }catch(e){
        esito.innerText = e.message;
        esito.style.color = "red";
    }
}
    &lt;/script&gt;
&lt;/head&gt;
&lt;body onload="caricaMenu()"&gt;
    &lt;h1&gt;Universal Food&lt;/h1&gt;
    &lt;p&gt;Inserimento piatto&lt;/p&gt;
    &lt;p&gt;Scegli il menu per il nuovo piatto: &lt;select id="menu" onchange="scelto()"&gt;&lt;/select&gt;&lt;/p&gt;

    &lt;p&gt;Nome: &lt;input type="text" id="nome"&gt;&lt;/p&gt;
    &lt;p&gt;Costo: &lt;input type="text" id="costo"&gt;&lt;/p&gt;
    &lt;p&gt;Descrizione: &lt;input type="text" id="descrizione"&gt;&lt;/p&gt;
    &lt;p&gt;&lt;button type="button" onclick="inviaNuovoPiatto()"&gt;invia nuovo piatto&lt;/button&gt;&lt;/p&gt; <span>&lt;!-- 7 !&gt;</span>
    &lt;p id="esito"&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

    <h2>Ulteriori funzionalità</h2>
    <p>La API di UniversalFood permette di svolgere ulteriori azioni che
    sono lasciate per esercizio.</p>

    <div class="esercizio">Aggiungere una funzionalità per avere
    tutte le informazioni su uno specifico piatto. </div>

    <div class="esercizio">Aggiungere una funzionalità
    per eliminare un piatto dal menu.</div>

    <div class="esercizio">Aggiungere una funzionalità
    per modificare un piatto già presente nel menù.</div>
</article>
</body>
</html>
