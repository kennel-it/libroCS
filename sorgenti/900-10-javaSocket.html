<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html>
<!-- autoIndex requires="protocolliFormati" group="java" coords="40,60" -->
<!-- changelog 2017-10-18 inserita prima parte del contenuto -->
<!-- changelog 2017-11-17 aggiunti chiarimenti in più per l'uso di flush e dei writer -->
<!-- changelog 2019-10-27 aggiunta parte su ServerSocket -->
<!-- changelog 2019-10-27 modificata struttura del capitolo -->
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
   	<meta charset="UTF-8"/>
       <title>javaSocket</title>
       <link type="text/css" rel="stylesheet" href="style.css"/>
       <script type="text/javascript" src="script/test.js"></script>         
   </head>
<body>
<header>
	<h1>javaSocket</h1>
	<p>oggetti per gestire le connessioni</p>
</header>
<article>

    <p>Java consente di gestire le connessioni via TCP/IP utilizzando due oggetti: 
    <code>Socket</code> e <code>ServerSocket</code> che si trovano nel pacchetto
    <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/net/package-summary.html">java.net</a></p>
    
    <p>Una volta avvenuta la connessione sarà possibile ottenere degli flussi di byte in 
    ingresso e in uscita che possono essere utilizzati esattamente come si fa con i file, da questi sarà
    possibile ottenere degli Writer o Read per scrivere o leggere carattere ecc...</p>

	
	<h2><a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/net/Socket.html">Socket</a></h2>
	<p>Questa è la classe che rappresenta uno dei due "capi" della connessione via TCP/IP.
	È possibile creare oggetti di questa classe direttamente oppure ottenerli in risposta ad una 
    richiesta di connessione.</p>
	<div class="test">
	   	<p>Quali parametri servono per avere una connessione TCP/IP verso un server?</p>
		<a onclick="sbagliata(this)">porta<span class="spiegazione">non basta</span></a> 
		<a onclick="sbagliata(this)">nome server<span class="spiegazione">non basta</span></a>
		<a onclick="giusta(this)">nome del server e porta</a> 
		<a onclick="sbagliata(this)">IP e porta<span class="spiegazione">può andare ma non è necessario avere l'ip...</span></a>
	</div>
	<p>La classe Socket ha un costruttore che ci permette di collegarci ad un server
	scrivendo semplicemente una istruzione del tipo 
	<code>Socket s = new Socket("snoopy.quercia.org",876)</code> in cui il primo parametro è 
	il nome del server e il secondo è la porta.</p>
	<p>Una volta creato l'oggetto è possibile ottenere il canale di uscita
	usando il metodo <code>getOutputStream()</code> (ritorna un OutputStream, cioè
	un oggetto ingrado di inviare byte) e poi usando questo si può costruire un OutputStreamWriter 
	per inviare caratteri.
	In maniera analoga si può avere il canale di ingresso
    utilizzando <code>getInputStream()</code> che ritorna un InputStream da cui di nuovo
    si può costruire un InputStreamReader.</p>
    
	<p>Gli OutputStream utilizzano dei buffer per la gestione dei dati. 
	Inviare un byte alla volta (o scriverlo su disco) è una operazione in generale poco sensata:
	per questo motivo gli stream accumulano una certa (non dichiarano la dimensione) quantità di dati
	e poi la inviano sulla rete o al disco poco cambia.</p>
	
	<p>Potrebbere però succedere che ci serva di inviare una piccola quantità di dati e possiamo 
	forzare il meccanismo: sia l'oggetto OutputStream che l'OutputStreamWriter hanno un metodo
	<code>flush()</code> che forza l'invio dei dati (o detto in altri termini chiede di svuotare i buffer).</p>
	
	<p>Un frammento di programma come quello qui sotto serve ad inviare una semplice
	stringa di testo al server:</p>
<pre>
Socket connessione = new Socket("snoopy.quercia.org",876);
OutputStream flussoByte = connessione.getOutputStream();
OutputStreamWriter flussoCaratteri = new OutputStreamWriter(flussoByte);
flussoCaratteri.write("saluti!\n");
// non uso flush() perché chiudo lo stream
flussoCaratteri.close();
flussoByte.close();
connessione.close();
</pre>
	 
	 <h2><a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/net/ServerSocket.html">ServerSocket</a></h2>

    <p>Questa classe è in grado di bloccare l'esecuzione del programma attendendo che qualcuno 
    si connetta via TCP/IP, una volta avvenuta la connessione quesllo che si ottiene 
    è di nuovo un oggetto Socket da cui è possibile ottenere dei flussi in ingresso/uscita.</p>
	 
<pre>
ServerSocket ss = new ServerSocket(7777)
// il metodo accept serve per mettersi in ascolto
Socket s = ss.accept();
// da questo punto posso usare il socket come in un client
</pre>

    <div class="test">
        <p>considerando il frammento di programma precedente cosa succede se dopo il primo client se ne connette
        un secondo?</p>
        <a onclick="giusta(this)">avrà un errore<span class="spiegazione">giusto, non c'è più nessuno in ascolto</span></a>
        <a onclick="sbagliata(this)">crea un altro Socket<span class="spiegazione">purtroppo no, non c'è più nessuno in ascolto</span></a> 
    </div>

</article>
</body>
</html>