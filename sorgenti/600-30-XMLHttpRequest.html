<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html>
<!-- autoIndex requires="richiestaHttp rispostaHttp architettureServizi" group="javascript" coords="70,50" -->
<!-- changelog 2018-01-24 inserita prima parte dei contenuti -->
<!-- changelog 2018-02-21 inserito esempio commentato di uso -->
<!-- changelog 2019-03-05 aggiunto controllo per stato della risposta -->
<!-- changelog 2020-03-01 aggiunta breve introduzione su altre tecnologie -->
<!-- changelog 2020-03-02 corretti errori minori -->
<!-- changelog 2021-02-12 spostato link   -->
<!-- changelog 2021-02-22 invio dei dati nel body con XMLhttpRequest   -->
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
   	<meta charset="UTF-8"/>
       <title>XMLHttpRequest</title>
       <link type="text/css" rel="stylesheet" href="style.css"/>
       <script type="text/javascript" src="script/test.js"></script>
   </head>
<body>
<header>
	<h1>XMLHttpRequest</h1>
	<p>richieste asincrone via javascript</p>
</header>
<article>
	<p>ci sono diversi modi per comunicare con un server da parte di una applicazione
	che gira in un browser e che ha bisogno di aver risposta per una singola richiesta: uno è
	<a href="https://developer.mozilla.org/it/docs/Web/API/Fetch_API">Fetch API</a>
	e l'altro sono le classiche
	<a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest">richieste asincrone XML</a>
	che ci accingiamo a vedere (e che non si usano soltanto per XML!).</p>

	<p><code>XMLHttpRequest</code> è un oggetto utilizzabile nei programmi
	Javascript per interagire con un server remoto comunicando tramite singole interazioni
	richiesta/risposta.</p>

	<p>Microsoft ha sviluppato inizialmengte questo oggetto (perché di un oggetto si tratta)
	prima del 2000, successivamente nel 2006 ne è stata publicata una bozza di
	<a href="https://www.w3.org/TR/XMLHttpRequest/">standard dal World Wide Web Consortium</a>.
	Come il nome suggerisce è stato inventato per trasferire contenuto XML
	ma attualmente viene usato per diversi formati di file.</p>

	<p>Lo scopo per cui viene usato è solitamente quello di trasferire informazioni senza cambiare
	l'intera pagina e senza bloccare l'utente in attesa di una risposta: viene inviata la richiesta
	al server e 	la pagina continua ad essere normalmente interattiva, all'arrivo della risposta
	questa verrà elaborata (in maniera asincrona) magari per aggiornare la pagina.</p>

	<h2>Breve riferimento</h2>
	<p>Quelle sotto sono le proprietà e i metodi più utili, per avere informazioni più dettagliate
	oltre che sulla pagina dello standard è possibile consultare
	<a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest">MDN</a> o
	<a href="https://www.w3schools.com/xml/xml_http.asp">w3schools</a>. </p>
	<dl>
		<dt>onreadystatechange</dt>
		<dd>è una funzione che viene chiamata ogni volta che cambia lo stato della richiesta</dd>
		<dt>open(metodo, risorsa)</dt>
		<dd>definisce quale metodo di HTTP (es: get o post) va usato e quale è la risorsa
		da recuperare</dd>
		<dt>send</dt>
		<dd>è il metodo che serve per inviare la richiesta</dd>
		<dt>readyState</dt>
		<dd>una variabile che contiene l'attuale
		<a href="https://developer.mozilla.org/it/docs/Web/API/XMLHttpRequest/readyState">stato dell'oggetto</a>
		</dd>
		<dt>responseText</dt>
		<dd>contiene la risposta del server o null in caso di errore</dd>
		<dt>status</dt>
		<dd><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/status">lo stato della risposta</a>
		</dd>
	</dl>
	<h2>Un esempio</h2>

<pre><code>
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset="UTF-8"&gt;
&lt;title&gt;Richiesta via http&lt;/title&gt;
&lt;script type="text/javascript"&gt;
"use strict";

<span class="evidenza">// conterrà la richiesta, deve essere globale perché</em>
<span class="evidenza">// viene usata in due diverse funzioni</em>
let httpRequest;

function statoCambiato(){

  <span class="evidenza">// lo stato è cambiato ma non è detto che sia già arrivata</em>
  <span class="evidenza">// la risposta (potrebbe ad esempio essere lo stato HEADERS_RECEIVED): controllo</em>
  <span class="evidenza">// sarebbe necessario anche controllare il valore contenuto in status</em>
  if (httpRequest.readyState === XMLHttpRequest.DONE) {

    if(httpRequest.status == 200){
      <span class="evidenza">// scrivo la risposta nel paragrafo identificato da "risposta"</em>
      document.getElementById("risposta").innerHTML = httpRequest.responseText;
    }else{
      <span class="evidenza">// scrivo il codice dell'errore nel paragrafo identificato da "risposta"</em>
      document.getElementById("risposta").innerHTML = "errore "+httpRequest.status;
    }

  }

}

function premuto(){

  <em>// creo l'oggetto</em>
  httpRequest = new XMLHttpRequest();

  <em>// imposto la funzione da chiamare ogni volta che ci sarà</em>
  <em>// un cambiamento di stato</em>
  httpRequest.onreadystatechange = statoCambiato;

  <em>// inizializzo la richiesta </em>
  httpRequest.open('GET', 'info.txt');

  <em>// invio la richiesta al server </em>
  httpRequest.send();
}

&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
<span class="evidenza ">
&lt;!-- l'attributo <code>onclick</code> indica al browser il codice javascript da eseguire quando
     l'utente fa click sull'elemento (un paragrafo in questo caso)  --&gt;</span>
&lt;p onclick="premuto()" id="risposta"&gt;premi qui&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;

</code></pre>

	<h2>Invio dei dati al server</h2>
	<h3>Nella URL</h3>
	<p>Il metodo più semplice per inviare dei dati al server (ad esempio dei parametri di ricerca)
	è quello di usare il metodo GET e scriverli direttamente nella URL:
	dopo il nome dello script va in inserito un "?" e si possono concatenare usando una "&amp;"</p>
	<p>Un esempio chiarirà tutto il da farsi: poniamo di voler inviare allo script "cercatore.php"
	due parametri per fare la ricerca: il primo è il <code>nome</code> dell'utente "bruce" e il secondo
	è il nome della <code>localita</code> in cui risiede.
	La nostra URL sarà: <code>cercatore.php<em>?</em>nome=bruce<em>&amp;</em>localita=gotham</code></p>
	<p>Da tener presente che alcuni caratteri nelle URL non possono essere inseriti perché riservati
	quindi va usata la funzione
	<a href="https://developer.mozilla.org/it/docs/Web/JavaScript/Reference/Global_Objects/encodeURI"><code>encodeURI(uri)</code></a>
	ad esempio scrivendo<code>URLDaInviare = encodeURI(miaStringa)</code>
	</p>

	<h3>Nel body</h3>
	<p>Spesso capita di dover però inviare molti dati ad un metodo POST e in questo caso dobbiamo inserirli nel body.
	Questa cosa non è difficile da fare usando XMLHttpRequest: basta specificare POST come metodo e
	passarli come parametro a <code>send()</code>, in poche parole:</p>

<pre><code>
httpRequest.open('POST', 'script.php');
httpRequest.send(corpoDelMessaggio);
</code></pre>


</article>
</body>
</html>
